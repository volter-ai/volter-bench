Role: system
Content: You are a helpful assistant specialized in changing files based on proposed changes.
__________________
Role: user
Content: ## Proposed Code Change
1. Analysis of the issue:
The error occurs because sometimes `skill` is None in `_calculate_damage`. This happens because in the `run` method, we're not properly handling the case where a player chooses to swap creatures - in that case, `player_action` is a Creature (for swapping) but we're still trying to use it as a skill in damage calculation.

The fix needs to:
- Properly handle the distinction between swap actions and attack actions in `_execute_turn`
- Keep the models as pure data schemas
- Stay within the engine's capabilities

2. Here's the fixed MainGameScene:

# Excerpt ID: 1f1b2ac6-d716-4b0c-bf9e-b394c6231be3
```python main_game/scenes/main_game_scene.py
from mini_game_engine.engine.lib import AbstractGameScene, Button, SelectThing
from main_game.models import Creature, Skill
import random

class MainGameScene(AbstractGameScene):
    def __init__(self, app, player):
        super().__init__(app, player)
        self.bot = app.create_bot("basic_opponent")
        
        # Initialize creatures
        for p in [self.player, self.bot]:
            p.active_creature = p.creatures[0]
            for c in p.creatures:
                c.hp = c.max_hp

    def __str__(self):
        p_creature = self.player.active_creature
        b_creature = self.bot.active_creature
        
        return f"""=== Battle ===
Your {p_creature.display_name}: {p_creature.hp}/{p_creature.max_hp} HP
Foe's {b_creature.display_name}: {b_creature.hp}/{b_creature.max_hp} HP

Your Team:
{self._format_team(self.player)}

Foe's Team:
{self._format_team(self.bot)}
"""

    def _format_team(self, player):
        return "\n".join([f"- {c.display_name}: {c.hp}/{c.max_hp} HP" for c in player.creatures])

    def _get_type_multiplier(self, skill_type: str, defender_type: str) -> float:
        if skill_type == defender_type:
            return 1.0
        
        effectiveness = {
            "fire": {"leaf": 2.0, "water": 0.5},
            "water": {"fire": 2.0, "leaf": 0.5},
            "leaf": {"water": 2.0, "fire": 0.5}
        }
        
        return effectiveness.get(skill_type, {}).get(defender_type, 1.0)

    def _calculate_damage(self, attacker: Creature, defender: Creature, skill: Skill) -> int:
        if skill.is_physical:
            raw_damage = attacker.attack + skill.base_damage - defender.defense
        else:
            raw_damage = (attacker.sp_attack / defender.sp_defense) * skill.base_damage
            
        multiplier = self._get_type_multiplier(skill.skill_type, defender.creature_type)
        return int(raw_damage * multiplier)

    def _handle_knocked_out(self, player):
        available = [c for c in player.creatures if c.hp > 0 and c != player.active_creature]
        if not available:
            return False
            
        choices = [SelectThing(c) for c in available]
        choice = self._wait_for_choice(player, choices)
        player.active_creature = choice.thing
        return True

    def _execute_turn(self, first_player, first_action, second_player, second_action):
        for player, action in [(first_player, first_action), (second_player, second_action)]:
            if isinstance(action, Creature):  # Swap action
                self._show_text(self.player, 
                    f"{player.display_name} swapped to {action.display_name}!")
                player.active_creature = action
            else:  # Attack action
                defender = second_player if player == first_player else first_player
                damage = self._calculate_damage(player.active_creature, defender.active_creature, action)
                defender.active_creature.hp = max(0, defender.active_creature.hp - damage)
                
                self._show_text(self.player, 
                    f"{player.active_creature.display_name} used {action.display_name}! "
                    f"Dealt {damage} damage to {defender.active_creature.display_name}!")
                
                if defender.active_creature.hp == 0:
                    if not self._handle_knocked_out(defender):
                        return defender  # Return the losing player
                        
        return None

    def run(self):
        while True:
            # Player turn
            attack_button = Button("Attack")
            swap_button = Button("Swap")
            choice = self._wait_for_choice(self.player, [attack_button, swap_button])
            
            player_action = None
            if choice == attack_button:
                skill_choices = [SelectThing(s) for s in self.player.active_creature.skills]
                player_action = self._wait_for_choice(self.player, skill_choices).thing
            else:  # Swap
                available = [c for c in self.player.creatures if c.hp > 0 and c != self.player.active_creature]
                if available:
                    swap_choices = [SelectThing(c) for c in available]
                    player_action = self._wait_for_choice(self.player, swap_choices).thing
                else:
                    # If no creatures to swap to, force an attack
                    skill_choices = [SelectThing(s) for s in self.player.active_creature.skills]
                    player_action = self._wait_for_choice(self.player, skill_choices).thing

            # Bot turn - always attacks, never swaps
            bot_action = random.choice(self.bot.active_creature.skills)
            
            # Determine turn order - swaps always go first
            if isinstance(player_action, Creature):
                first_player, first_action = self.player, player_action
                second_player, second_action = self.bot, bot_action
            elif isinstance(bot_action, Creature):
                first_player, first_action = self.bot, bot_action
                second_player, second_action = self.player, player_action
            else:  # Both are attacks, use speed
                if self.player.active_creature.speed > self.bot.active_creature.speed:
                    first_player, first_action = self.player, player_action
                    second_player, second_action = self.bot, bot_action
                else:
                    first_player, first_action = self.bot, bot_action
                    second_player, second_action = self.player, player_action
            
            # Execute turn and check for game end
            loser = self._execute_turn(first_player, first_action, second_player, second_action)
            if loser:
                self._show_text(self.player, 
                    "You won!" if loser == self.bot else "You lost!")
                self._transition_to_scene("MainMenuScene")
```

The key changes are:
1. Added type hint for skill parameter in `_calculate_damage`
2. Improved action handling in `_execute_turn` to properly distinguish between swap and attack actions
3. Made bot always attack (never swap) to simplify logic
4. Added fallback to attack if player tries to swap but has no valid swap targets
5. Improved turn order logic to always prioritize swaps before attacks
6. Added proper text feedback for swap actions

These changes maintain the pure data schema nature of the models while fixing the None skill issue by ensuring proper action type handling throughout the battle system.

## Directions
Reply with a list of actions in the following format. The response should only contain the JSON list of actions, no other text.
Make sure you are using the excerpt_id which contains the entire contents of the file.

Each action in the list must have these fields:
- action: Must be "overwrite"
- excerpt_id: The ID of the excerpt to use
- file_path: The relative path to the file

Example format for multiple files:
[
    {
        "action": "overwrite",
        "excerpt_id": "abc1",
        "file_path": "src/main.py"
    },
    {
        "action": "overwrite",
        "excerpt_id": "def2",
        "file_path": "tests/test_main.py"
    }
]
__________________
Role: assistant
Content: 
__________________
